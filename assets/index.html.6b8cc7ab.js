import{r as s,o as n,c as a,a as l,F as p,d as o,b as F}from"./app.d8cb38ab.js";const e={},t=o('<h2 id="throttle" tabindex="-1"><a class="header-anchor" href="#throttle" aria-hidden="true">#</a> throttle</h2><div class="custom-container tip"><p class="custom-container-title">节流</p><p>持续触发事件，每隔一段时间，只执行一次事件。</p></div><ul><li>时间戳版：最后一次触发的时间少于 <code>wait</code>，则导致最后一次触发并没有执行函数</li><li>定时器版：首次触发事件的时候不会执行函数</li><li>结合版： <ul><li>首次触发事件立即执行</li><li>停止触发事件后依然再执行一次事件</li></ul></li></ul><details><summary>展开查看</summary><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * 节流</span></span>\n<span class="line"><span style="color:#88846F;"> * 持续触发事件，每隔一段时间，只执行一次事件。</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{*}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">func</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{*}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">wait</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{*}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">immediate</span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// 时间戳版</span></span>\n<span class="line"><span style="color:#88846F;">// function throttle(func, wait, immediate) {</span></span>\n<span class="line"><span style="color:#88846F;">//   let previous = 0;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">//   return function () {</span></span>\n<span class="line"><span style="color:#88846F;">//     const context = this;</span></span>\n<span class="line"><span style="color:#88846F;">//     const args = arguments;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">//     const now = Date.now();</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">//     if (now - previous &gt; wait) {</span></span>\n<span class="line"><span style="color:#88846F;">//       previous = now;</span></span>\n<span class="line"><span style="color:#88846F;">//       func.apply(context, args);</span></span>\n<span class="line"><span style="color:#88846F;">//     }</span></span>\n<span class="line"><span style="color:#88846F;">//   };</span></span>\n<span class="line"><span style="color:#88846F;">// }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// 定时器</span></span>\n<span class="line"><span style="color:#88846F;">// function throttle(func, wait) {</span></span>\n<span class="line"><span style="color:#88846F;">//   let timer;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">//   return function () {</span></span>\n<span class="line"><span style="color:#88846F;">//     const context = this;</span></span>\n<span class="line"><span style="color:#88846F;">//     const args = arguments;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">//     if(!timer) {</span></span>\n<span class="line"><span style="color:#88846F;">//       timer = setTimeout(() =&gt; {</span></span>\n<span class="line"><span style="color:#88846F;">//         timer = null;</span></span>\n<span class="line"><span style="color:#88846F;">//         func.apply(context, args);</span></span>\n<span class="line"><span style="color:#88846F;">//       }, wait);</span></span>\n<span class="line"><span style="color:#88846F;">//     }</span></span>\n<span class="line"><span style="color:#88846F;">//   };</span></span>\n<span class="line"><span style="color:#88846F;">// }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// 结合版</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">throttle</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">fn</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">wait</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> timer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> previous </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> () {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> context </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> args </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">arguments</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> now </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Date</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">now</span><span style="color:#F8F8F2;">();</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 下次触发 fn 剩余时间</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> remaining </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> wait </span><span style="color:#F92672;">-</span><span style="color:#F8F8F2;"> (now </span><span style="color:#F92672;">-</span><span style="color:#F8F8F2;"> previous);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;">clearTimeout</span><span style="color:#F8F8F2;">(timer);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (remaining </span><span style="color:#F92672;">&lt;=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 没有剩余时间（或者首次） 立即触发 fn</span></span>\n<span class="line"><span style="color:#F8F8F2;">      fn.</span><span style="color:#A6E22E;">apply</span><span style="color:#F8F8F2;">(context, args);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      previous </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Date</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">now</span><span style="color:#F8F8F2;">();</span></span>\n<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 最后一次触发，在剩余时间后执行</span></span>\n<span class="line"><span style="color:#F8F8F2;">      timer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;">setTimeout</span><span style="color:#F8F8F2;">(fn, remaining);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  };</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">fn</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> () </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;font-style:italic;">Date</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">now</span><span style="color:#F8F8F2;">());</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> th </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">throttle</span><span style="color:#F8F8F2;">(fn, </span><span style="color:#AE81FF;">1000</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;">setInterval</span><span style="color:#F8F8F2;">(th, </span><span style="color:#AE81FF;">10</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"></span></code></pre></div></details><hr><h2 id="debounce" tabindex="-1"><a class="header-anchor" href="#debounce" aria-hidden="true">#</a> debounce</h2><div class="custom-container tip"><p class="custom-container-title">防抖</p><p>触发高频事件 N 秒后只会执行一次，如果 N 秒内事件再次触发，则会重新计时</p></div><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * 防抖</span></span>\n<span class="line"><span style="color:#88846F;"> * 触发高频事件 N 秒后只会执行一次，如果 N 秒内事件再次触发，则会重新计时。</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{Function}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">func</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{Number}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">wait</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{Boolean}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">immediate</span><span style="color:#88846F;"> 立即执行</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@returns</span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// 简单版</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">debounce</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">fn</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">wait</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> timer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> () {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> args </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">arguments</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> context </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;">clearTimeout</span><span style="color:#F8F8F2;">(timer);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    timer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;">setTimeout</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> () {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      fn.</span><span style="color:#A6E22E;">apply</span><span style="color:#F8F8F2;">(context, args);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }, wait);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  };</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// 可立即执行、可取消 版</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">debounce</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">func</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">wait</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">immediate</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> timer, result;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">var</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">debounced</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> () {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> context </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> args </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">arguments</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (timer) </span><span style="color:#66D9EF;">clearTimeout</span><span style="color:#F8F8F2;">(timer);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (immediate) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 是否执行过</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> called </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> timer;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 等待 wait 秒后才可再次触发函数执行</span></span>\n<span class="line"><span style="color:#F8F8F2;">      timer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;">setTimeout</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        timer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }, wait);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 如果没执行过，立即执行</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">!</span><span style="color:#F8F8F2;">called) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        result </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> func.</span><span style="color:#A6E22E;">apply</span><span style="color:#F8F8F2;">(context, args);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      timer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;">setTimeout</span><span style="color:#F8F8F2;">(</span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> () {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        func.</span><span style="color:#A6E22E;">apply</span><span style="color:#F8F8F2;">(context, args);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }, wait);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 返回函数执行结果</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> result;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  };</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 取消方法</span></span>\n<span class="line"><span style="color:#F8F8F2;">  debounced.</span><span style="color:#A6E22E;">cancel</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> () {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;">clearTimeout</span><span style="color:#F8F8F2;">(timer);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    timer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  };</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> debounced;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">fn</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">a</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(a);</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> de </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">debounce</span><span style="color:#F8F8F2;">(fn, </span><span style="color:#AE81FF;">1000</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#A6E22E;">de</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">23333333</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"></span></code></pre></div><hr><h2 id="new" tabindex="-1"><a class="header-anchor" href="#new" aria-hidden="true">#</a> new</h2><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * -------- new 操作符 过程 ------------</span></span>\n<span class="line"><span style="color:#88846F;"> * (1) 在内存中创建一个新对象。</span></span>\n<span class="line"><span style="color:#88846F;"> * (2) 这个新对象内部的[[Prototype]]特性被赋值为构造函数的 prototype 属性。</span></span>\n<span class="line"><span style="color:#88846F;"> * (3) 构造函数内部的 this 被赋值为这个新对象（即 this 指向新对象）。</span></span>\n<span class="line"><span style="color:#88846F;"> * (4) 执行构造函数内部的代码（给新对象添加属性）。</span></span>\n<span class="line"><span style="color:#88846F;"> * (5) 如果构造函数返回非空对象，则返回该对象；否则，返回刚创建的新对象。</span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">newOperator</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">ctor</span><span style="color:#F8F8F2;">, </span><span style="color:#F92672;">...</span><span style="color:#FD971F;font-style:italic;">args</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 在内存中创建一个新对象。</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> obj </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> {};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 这个新对象内部的[[Prototype]]特性被赋值为构造函数的 prototype 属性。</span></span>\n<span class="line"><span style="color:#F8F8F2;">  obj.__proto__ </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">ctor</span><span style="color:#F8F8F2;">.prototype;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 构造函数内部的 this 被赋值为这个新对象（即 this 指向新对象）</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 执行构造函数内部的代码（给新对象添加属性）。</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> ctor.</span><span style="color:#A6E22E;">apply</span><span style="color:#F8F8F2;">(obj, args);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 如果构造函数返回非空对象，则返回该对象；否则，返回刚创建的新对象</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// （如果构造函数返回值为 【引用类型】则直接返回构造函数返回值，否则返回新创建的对象）</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> ((result </span><span style="color:#F92672;">&amp;&amp;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;object&#39;</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">||</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> result;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> obj;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">newFn</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">ctor</span><span style="color:#F8F8F2;">, </span><span style="color:#F92672;">...</span><span style="color:#FD971F;font-style:italic;">args</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> obj </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">create</span><span style="color:#F8F8F2;">(ctor);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> ctor.</span><span style="color:#A6E22E;">apply</span><span style="color:#F8F8F2;">(obj, args);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> ((result </span><span style="color:#F92672;">&amp;&amp;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;object&#39;</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">||</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> result;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> obj;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><hr><h2 id="instanceof" tabindex="-1"><a class="header-anchor" href="#instanceof" aria-hidden="true">#</a> instanceof</h2><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">instanceOf</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">left</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">right</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">while</span><span style="color:#F8F8F2;"> (left) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(left.__proto__ </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">right</span><span style="color:#F8F8F2;">.prototype) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">true</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    left </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> left.__proto__</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">false</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// function instanceOf(left, right) {</span></span>\n<span class="line"><span style="color:#88846F;">//   let proto = left.__proto__</span></span>\n<span class="line"><span style="color:#88846F;">//   while (true) {</span></span>\n<span class="line"><span style="color:#88846F;">//       if (proto === null) return false</span></span>\n<span class="line"><span style="color:#88846F;">//       if (proto === right.prototype) {</span></span>\n<span class="line"><span style="color:#88846F;">//           return true</span></span>\n<span class="line"><span style="color:#88846F;">//       }</span></span>\n<span class="line"><span style="color:#88846F;">//       proto = proto.__proto__</span></span>\n<span class="line"><span style="color:#88846F;">//   }</span></span>\n<span class="line"><span style="color:#88846F;">// }</span></span>\n<span class="line"></span></code></pre></div><hr><h2 id="object-create" tabindex="-1"><a class="header-anchor" href="#object-create" aria-hidden="true">#</a> Object.create</h2><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * 实现 Object.create</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{*}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">proto</span><span style="color:#88846F;"> </span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{*}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">propertyObject</span><span style="color:#88846F;"> </span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@returns</span><span style="color:#88846F;"> </span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">create</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">proto</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">propertyObject</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">undefined</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> proto </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;object&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">&amp;&amp;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> proto </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;Object prototype may only be an Object or null.&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (propertyObject </span><span style="color:#F92672;">==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;Cannot convert undefined or null to object&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 原型继承</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">F</span><span style="color:#F8F8F2;">() {}</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">F</span><span style="color:#F8F8F2;">.prototype </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> proto;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> obj </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">F</span><span style="color:#F8F8F2;">();</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 第二个参数是 新对象定义额外属性的对象</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (propertyObject) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">defineProperty</span><span style="color:#F8F8F2;">(obj, propertyObject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// Object.create(null) 是一个没有原型的对象</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 所以如果参数是 null 则设置隐式原型为 null</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (proto </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    obj.__proto__ </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> obj;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">create</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">));</span></span>\n<span class="line"><span style="color:#F8F8F2;">console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">create</span><span style="color:#F8F8F2;">({}));</span></span>\n<span class="line"><span style="color:#F8F8F2;">console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">create</span><span style="color:#F8F8F2;">([]));</span></span>\n<span class="line"></span></code></pre></div><hr><h2 id="deepclone" tabindex="-1"><a class="header-anchor" href="#deepclone" aria-hidden="true">#</a> deepClone</h2><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * 深克隆</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{*}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">obj</span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">isObject</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;font-style:italic;">target</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> target </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&quot;object&quot;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">||</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> target </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&quot;function&quot;</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">&amp;&amp;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  target </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// const typeName = (target) =&gt; target.constructor.name</span></span>\n<span class="line"><span style="color:#88846F;">// const typeName = (target) =&gt; {</span></span>\n<span class="line"><span style="color:#88846F;">//   const res = Object.prototype.toString.call(target).split(&#39; &#39;)[1]</span></span>\n<span class="line"><span style="color:#88846F;">//   return res.substr(0, res.length - 1)</span></span>\n<span class="line"><span style="color:#88846F;">// }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">deepClone</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">target</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">map</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">WeakMap</span><span style="color:#F8F8F2;">()) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 若已存在 返回目标</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (map.</span><span style="color:#A6E22E;">has</span><span style="color:#F8F8F2;">(target)) </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> target;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 获取目标构造函数</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> constructor </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> target.constructor;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 正则、日期类型 利用构造器创建新的元素返回</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#E6DB74;">/</span><span style="color:#F92672;">^</span><span style="color:#E6DB74;">(RegExp</span><span style="color:#F92672;">|</span><span style="color:#E6DB74;">Date)</span><span style="color:#F92672;">$</span><span style="color:#E6DB74;">/</span><span style="color:#F92672;">i</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">test</span><span style="color:#F8F8F2;">(constructor.name)) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">constructor</span><span style="color:#F8F8F2;">(target);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 递归引用类型</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#A6E22E;">isObject</span><span style="color:#F8F8F2;">(target)) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 为循环引用的对象做标记</span></span>\n<span class="line"><span style="color:#F8F8F2;">    map.</span><span style="color:#A6E22E;">set</span><span style="color:#F8F8F2;">(target, </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> newObj </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Array</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">isArray</span><span style="color:#F8F8F2;">(target) </span><span style="color:#F92672;">?</span><span style="color:#F8F8F2;"> [] </span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> {};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">for</span><span style="color:#F8F8F2;"> (</span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> key </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> target) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">.hasOwnProperty.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(target, key)) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        newObj[key] </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">deepClone</span><span style="color:#F8F8F2;">(target[key], map);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> newObj;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> target;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><hr><h2 id="array" tabindex="-1"><a class="header-anchor" href="#array" aria-hidden="true">#</a> Array</h2><h3 id="call" tabindex="-1"><a class="header-anchor" href="#call" aria-hidden="true">#</a> call</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">Function</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">context</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> window, </span><span style="color:#F92672;">...</span><span style="color:#FD971F;font-style:italic;">args</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;Type Error&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 生成临时唯一 key，防止覆盖原有属性</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> fn </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Symbol</span><span style="color:#F8F8F2;">();</span></span>\n<span class="line"><span style="color:#F8F8F2;">  context[fn] </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> context[fn](</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">delete</span><span style="color:#F8F8F2;"> context[fn];</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> result;</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"></span></code></pre></div><h3 id="apply" tabindex="-1"><a class="header-anchor" href="#apply" aria-hidden="true">#</a> apply</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">Function</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#A6E22E;">apply</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">context</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> window, </span><span style="color:#FD971F;font-style:italic;">args</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;Type Error&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 生成临时唯一 key，防止覆盖原有属性</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> fn </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Symbol</span><span style="color:#F8F8F2;">();</span></span>\n<span class="line"><span style="color:#F8F8F2;">  context[fn] </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> context[fn](</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">delete</span><span style="color:#F8F8F2;"> context[fn];</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> result;</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"></span></code></pre></div><h3 id="bind" tabindex="-1"><a class="header-anchor" href="#bind" aria-hidden="true">#</a> bind</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">Function</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#A6E22E;">bind</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">context</span><span style="color:#F8F8F2;">, </span><span style="color:#F92672;">...</span><span style="color:#FD971F;font-style:italic;">args</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;Type Error&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> self </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">F</span><span style="color:#F8F8F2;">() {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 如果是 new 的情况</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">instanceof</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">F</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">self</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args, </span><span style="color:#F92672;">...</span><span style="color:#FD971F;">arguments</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> self.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(context, </span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args, </span><span style="color:#F92672;">...</span><span style="color:#FD971F;">arguments</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  };</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"></span></code></pre></div><h3 id="foreach" tabindex="-1"><a class="header-anchor" href="#foreach" aria-hidden="true">#</a> forEach</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">Array</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#A6E22E;">forEach2</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">callback</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">thisArg</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;this is null or not defined&#39;</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> callback </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&quot;function&quot;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(callback </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39; is not a function&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> O </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> len </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> O.length </span><span style="color:#F92672;">&gt;&gt;&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> k </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">while</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">&lt;</span><span style="color:#F8F8F2;"> len) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> O) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      callback.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(thisArg, O[k], k, O)</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    k</span><span style="color:#F92672;">++</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><h3 id="map" tabindex="-1"><a class="header-anchor" href="#map" aria-hidden="true">#</a> map</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">Array</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#A6E22E;">map2</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">callback</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">thisArg</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;this is null or not defined&#39;</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> callback </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&quot;function&quot;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(callback </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39; is not a function&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> O </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> len </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> O.length </span><span style="color:#F92672;">&gt;&gt;&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> k </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 基于forEach,增加一个新的数组</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> res </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> [];</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">while</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">&lt;</span><span style="color:#F8F8F2;"> len) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> O) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 保存回调函数的返回值，组成新的数组</span></span>\n<span class="line"><span style="color:#F8F8F2;">      res[k] </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> callback.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(thisArg, O[k], k, O)</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    k</span><span style="color:#F92672;">++</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 返回这个新的数组</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> res;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><h3 id="some" tabindex="-1"><a class="header-anchor" href="#some" aria-hidden="true">#</a> some</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">Array</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#A6E22E;">some2</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">callback</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">thisArg</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;this is null or not defined&#39;</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> callback </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&quot;function&quot;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(callback </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39; is not a function&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> O </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> len </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> O.length </span><span style="color:#F92672;">&gt;&gt;&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> k </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">while</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">&lt;</span><span style="color:#F8F8F2;"> len) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> O) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 如果有满足条件，返回true</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(callback.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(thisArg, O[k], k, O)) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    k</span><span style="color:#F92672;">++</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 不满足条件 返回 false</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">false</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><h3 id="every" tabindex="-1"><a class="header-anchor" href="#every" aria-hidden="true">#</a> every</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">Array</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#A6E22E;">every2</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">callback</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">thisArg</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;this is null or not defined&#39;</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> callback </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&quot;function&quot;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(callback </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39; is not a function&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> O </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> len </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> O.length </span><span style="color:#F92672;">&gt;&gt;&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> k </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">while</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">&lt;</span><span style="color:#F8F8F2;"> len) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> O) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 如果有不满足条件，返回 false</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">!</span><span style="color:#F8F8F2;">callback.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(thisArg, O[k], k, O)) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">false</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    k</span><span style="color:#F92672;">++</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 所有都满足条件 返回 true</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><h3 id="filter" tabindex="-1"><a class="header-anchor" href="#filter" aria-hidden="true">#</a> filter</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">Array</span><span style="color:#F8F8F2;">.prototype.</span><span style="color:#A6E22E;">filter2</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">callback</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">thisArg</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;this is null or not defined&#39;</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> callback </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&quot;function&quot;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(callback </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39; is not a function&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> O </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> len </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> O.length </span><span style="color:#F92672;">&gt;&gt;&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span></span>\n<span class="line"></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> k </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 基于forEach,增加一个新的数组</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> res </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> [];</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">while</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">&lt;</span><span style="color:#F8F8F2;"> len) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(k </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> O) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 将满足条件的元素推入新数组</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;">(callback.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(thisArg, O[k], k, O)) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        res.</span><span style="color:#A6E22E;">push</span><span style="color:#F8F8F2;">(O[k]);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    k</span><span style="color:#F92672;">++</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 返回这个新的数组</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> res;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><h3 id="flatten" tabindex="-1"><a class="header-anchor" href="#flatten" aria-hidden="true">#</a> flatten</h3><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * 数组拍平</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{Array}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">arr</span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// es5</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">flatten</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">arr</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> result </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> [];</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">for</span><span style="color:#F8F8F2;"> (</span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> i </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">; i </span><span style="color:#F92672;">&lt;</span><span style="color:#F8F8F2;"> arr.length; i</span><span style="color:#F92672;">++</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#66D9EF;font-style:italic;">Array</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">isArray</span><span style="color:#F8F8F2;">(arr[i])) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      result </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> result.</span><span style="color:#A6E22E;">concat</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">flatten</span><span style="color:#F8F8F2;">(arr[i]));</span></span>\n<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      result.</span><span style="color:#A6E22E;">push</span><span style="color:#F8F8F2;">(arr[i]);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> result;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// es6</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">flatten</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">arr</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">while</span><span style="color:#F8F8F2;"> (arr.</span><span style="color:#A6E22E;">some</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">i</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Array</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">isArray</span><span style="color:#F8F8F2;">(i))) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    arr </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> [].</span><span style="color:#A6E22E;">concat</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">arr);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> arr;</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><h2 id="promise" tabindex="-1"><a class="header-anchor" href="#promise" aria-hidden="true">#</a> Promise</h2><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * 按 A+ 规范 实现 Promise</span></span>\n<span class="line"><span style="color:#88846F;"> * https://promisesaplus.com/</span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> PENDING </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;pending&#39;</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> FULFILLED </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;fulfilled&#39;</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> REJECTED </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;rejected&#39;</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// resolve Promise</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">resolvePromise</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">promise2</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">x</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">reject</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 判断 promise2 和 x 是否同一个</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 同一个 直接抛错</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (promise2 </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> x) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">TypeError</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;Chaining cycle detected for promise #&lt;Promise&gt;&#39;</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"><span style="color:#F8F8F2;">    );</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> called; </span><span style="color:#88846F;">// 处理 成功 和 失败 都被调用的情况，防止多次调用</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 判断 x 是否 对象 或 函数</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> ((</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> x </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;object&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">&amp;&amp;</span><span style="color:#F8F8F2;"> x </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">) </span><span style="color:#F92672;">||</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> x </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 兼容 A+ 规范</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">try</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> then </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> x.then;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> then </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#88846F;">// 有 then 可能是 promise，</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#88846F;">// 采用执行结果 向下传递</span></span>\n<span class="line"><span style="color:#F8F8F2;">        then.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(</span></span>\n<span class="line"><span style="color:#F8F8F2;">          x,</span></span>\n<span class="line"><span style="color:#F8F8F2;">          (</span><span style="color:#FD971F;font-style:italic;">y</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (called) </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">            called </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// y 可能还是 promise，递归处理直到解析出来的结果是普通值</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#A6E22E;">resolvePromise</span><span style="color:#F8F8F2;">(promise2, y, resolve, reject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">          },</span></span>\n<span class="line"><span style="color:#F8F8F2;">          (</span><span style="color:#FD971F;font-style:italic;">r</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (called) </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">            called </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(r);</span></span>\n<span class="line"><span style="color:#F8F8F2;">          }</span></span>\n<span class="line"><span style="color:#F8F8F2;">        );</span></span>\n<span class="line"><span style="color:#F8F8F2;">      } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#88846F;">// 可能是个普通值，直接成功</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(x);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#F92672;">catch</span><span style="color:#F8F8F2;"> (e) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (called) </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      called </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(e);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 普通值 直接成功返回</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(x);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">isPromise</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">value</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> value </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">||</span></span>\n<span class="line"><span style="color:#F8F8F2;">    (</span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> value </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;object&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">&amp;&amp;</span><span style="color:#F8F8F2;"> value </span><span style="color:#F92672;">!==</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"><span style="color:#F8F8F2;">  ) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (value.then) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">false</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">Promise</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">executor</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.status </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> PENDING;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.value </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">undefined</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.reason </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">undefined</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// resolve 状态回调数组</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.onResolvedCallbacks </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> [];</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// reject 状态回调数组</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.onRejectedCallbacks </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> [];</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">value</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.status </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> PENDING) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.status </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> FULFILLED;</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.value </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> value;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.onResolvedCallbacks.</span><span style="color:#A6E22E;">forEach</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">cb</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">cb</span><span style="color:#F8F8F2;">());</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    };</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">reason</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.status </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> PENDING) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.status </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> REJECTED;</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.reason </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> reason;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.onRejectedCallbacks.</span><span style="color:#A6E22E;">forEach</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">cb</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">cb</span><span style="color:#F8F8F2;">());</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    };</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">try</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#A6E22E;">executor</span><span style="color:#F8F8F2;">(resolve, reject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    } </span><span style="color:#F92672;">catch</span><span style="color:#F8F8F2;"> (error) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(error);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(error);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;">   * setTimeout 异步模拟微任务（因为无法实现微任务）</span></span>\n<span class="line"><span style="color:#88846F;">   */</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">onFulfilled</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">onRejected</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 透传</span></span>\n<span class="line"><span style="color:#F8F8F2;">    onFulfilled </span><span style="color:#F92672;">=</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> onFulfilled </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">?</span><span style="color:#F8F8F2;"> onFulfilled </span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">val</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> val;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    onRejected </span><span style="color:#F92672;">=</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">typeof</span><span style="color:#F8F8F2;"> onRejected </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;function&#39;</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#F92672;">?</span><span style="color:#F8F8F2;"> onRejected</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">err</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> err;</span></span>\n<span class="line"><span style="color:#F8F8F2;">          };</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// then 可链式调用， 且传递的是一个 Promise。所以这里返回一个新的 Promise 进行传递</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> promise2 </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">reject</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.status </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> FULFILLED) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#66D9EF;">setTimeout</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#F92672;">try</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> x </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">onFulfilled</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.value);</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#A6E22E;">resolvePromise</span><span style="color:#F8F8F2;">(promise2, x, resolve, reject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">          } </span><span style="color:#F92672;">catch</span><span style="color:#F8F8F2;"> (error) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(error);</span></span>\n<span class="line"><span style="color:#F8F8F2;">          }</span></span>\n<span class="line"><span style="color:#F8F8F2;">        });</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.status </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> REJECTED) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#66D9EF;">setTimeout</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#F92672;">try</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> x </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">onRejected</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.reason);</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#A6E22E;">resolvePromise</span><span style="color:#F8F8F2;">(promise2, x, resolve, reject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">          } </span><span style="color:#F92672;">catch</span><span style="color:#F8F8F2;"> (error) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(error);</span></span>\n<span class="line"><span style="color:#F8F8F2;">          }</span></span>\n<span class="line"><span style="color:#F8F8F2;">        });</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 异步时调用 then 的时候状态还是 PENDING</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// （链式调用时，新的状态也是 PENDING）</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.status </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> PENDING) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.onResolvedCallbacks.</span><span style="color:#A6E22E;">push</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#66D9EF;">setTimeout</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#F92672;">try</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">              </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> x </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">onFulfilled</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.value);</span></span>\n<span class="line"><span style="color:#F8F8F2;">              </span><span style="color:#A6E22E;">resolvePromise</span><span style="color:#F8F8F2;">(promise2, x, resolve, reject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">            } </span><span style="color:#F92672;">catch</span><span style="color:#F8F8F2;"> (error) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">              </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(error);</span></span>\n<span class="line"><span style="color:#F8F8F2;">            }</span></span>\n<span class="line"><span style="color:#F8F8F2;">          });</span></span>\n<span class="line"><span style="color:#F8F8F2;">        });</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.onRejectedCallbacks.</span><span style="color:#A6E22E;">push</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#66D9EF;">setTimeout</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#F92672;">try</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">              </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> x </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">onRejected</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.reason);</span></span>\n<span class="line"><span style="color:#F8F8F2;">              </span><span style="color:#A6E22E;">resolvePromise</span><span style="color:#F8F8F2;">(promise2, x, resolve, reject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">            } </span><span style="color:#F92672;">catch</span><span style="color:#F8F8F2;"> (error) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">              </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(error);</span></span>\n<span class="line"><span style="color:#F8F8F2;">            }</span></span>\n<span class="line"><span style="color:#F8F8F2;">          });</span></span>\n<span class="line"><span style="color:#F8F8F2;">        });</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    });</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> promise2;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 捕获前面 onFulfilled / onRejected 抛出的异常</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">catch</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">onReject</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">, onReject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// finally</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">finally</span><span style="color:#F8F8F2;">() {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">(</span></span>\n<span class="line"><span style="color:#F8F8F2;">      (</span><span style="color:#FD971F;font-style:italic;">value</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">cb</span><span style="color:#F8F8F2;">()).</span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> value),</span></span>\n<span class="line"><span style="color:#F8F8F2;">      (</span><span style="color:#FD971F;font-style:italic;">reason</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">cb</span><span style="color:#F8F8F2;">()).</span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#F92672;">throw</span><span style="color:#F8F8F2;"> reason;</span></span>\n<span class="line"><span style="color:#F8F8F2;">        })</span></span>\n<span class="line"><span style="color:#F8F8F2;">    );</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// resolve</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">static</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">value</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 如果传入的是 Promise 实例 直接返回</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (value </span><span style="color:#F92672;">instanceof</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">Promise</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> value;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(value);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    });</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// reject</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">static</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">reason</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">reject</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(reason);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    });</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;">   * all （Promise.all 调用）</span></span>\n<span class="line"><span style="color:#88846F;">   * 当传入的数组里所有promise状态都变成fulfilled的时候，resolve</span></span>\n<span class="line"><span style="color:#88846F;">   * 否则 reject</span></span>\n<span class="line"><span style="color:#88846F;">   * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{Array}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">promises</span></span>\n<span class="line"><span style="color:#88846F;">   * </span><span style="color:#66D9EF;font-style:italic;">@returns</span><span style="color:#88846F;"> Promise 实例</span></span>\n<span class="line"><span style="color:#88846F;">   */</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">static</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">all</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">promises</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">reject</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> count </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> values </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> [];</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">processData</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">k</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">v</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        values[k] </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> v;</span></span>\n<span class="line"><span style="color:#F8F8F2;">        count</span><span style="color:#F92672;">++</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#88846F;">// 结果数组长度等于执行了所有 promise 计数时，代表全部都已有结果</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (values.length </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> count) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(values);</span></span>\n<span class="line"><span style="color:#F8F8F2;">        }</span></span>\n<span class="line"><span style="color:#F8F8F2;">      };</span></span>\n<span class="line"><span style="color:#F8F8F2;">      promises.</span><span style="color:#A6E22E;">forEach</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">promise</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">i</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#A6E22E;">isPromise</span><span style="color:#F8F8F2;">(promise)) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 收集每个 promise 的resolve 状态，并计数</span></span>\n<span class="line"><span style="color:#F8F8F2;">          promise.</span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">value</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#A6E22E;">processData</span><span style="color:#F8F8F2;">(i, value);</span></span>\n<span class="line"><span style="color:#F8F8F2;">          }, reject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">        } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#A6E22E;">processData</span><span style="color:#F8F8F2;">(i, promise);</span></span>\n<span class="line"><span style="color:#F8F8F2;">        }</span></span>\n<span class="line"><span style="color:#F8F8F2;">      });</span></span>\n<span class="line"><span style="color:#F8F8F2;">    });</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;">   * race (Prommise.race)</span></span>\n<span class="line"><span style="color:#88846F;">   * 有其中一个状态改变时，立即返回状态</span></span>\n<span class="line"><span style="color:#88846F;">   * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{Array}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">promises</span></span>\n<span class="line"><span style="color:#88846F;">   * </span><span style="color:#66D9EF;font-style:italic;">@returns</span><span style="color:#88846F;"> Promise 实例</span></span>\n<span class="line"><span style="color:#88846F;">   */</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">static</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">race</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">promises</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">reject</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      promises.</span><span style="color:#A6E22E;">forEach</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">p</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        p.</span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">(resolve, reject);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      });</span></span>\n<span class="line"><span style="color:#F8F8F2;">    });</span></span>\n<span class="line"><span style="color:#F8F8F2;">  }</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// promises-aplus-tests 测试是否符合 promise A+规范</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">.defer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">deferred</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> () {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> dfd </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> {};</span></span>\n<span class="line"><span style="color:#F8F8F2;">  dfd.promise </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">reject</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    dfd.resolve </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> resolve;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    dfd.reject </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> reject;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  });</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> dfd;</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">module</span><span style="color:#F8F8F2;">.</span><span style="color:#66D9EF;font-style:italic;">exports</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"></span></code></pre></div><h2 id="柯里化" tabindex="-1"><a class="header-anchor" href="#柯里化" aria-hidden="true">#</a> 柯里化</h2><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * 柯里化</span></span>\n<span class="line"><span style="color:#88846F;"> * 柯里化就是把接受「多个参数」的函数变换成接受一个「单一参数」的函数，</span></span>\n<span class="line"><span style="color:#88846F;"> * 并且返回接受「余下参数」返回结果的一种应用。</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;"> </span><span style="color:#A6E22E;text-decoration:underline;">{*}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">fn</span></span>\n<span class="line"><span style="color:#88846F;"> * </span><span style="color:#66D9EF;font-style:italic;">@param</span><span style="color:#88846F;">  </span><span style="color:#A6E22E;text-decoration:underline;">{...any}</span><span style="color:#88846F;"> </span><span style="color:#F8F8F2;">args</span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">currying</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">fn</span><span style="color:#F8F8F2;">, </span><span style="color:#F92672;">...</span><span style="color:#FD971F;font-style:italic;">args</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(fn, args);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// fn.length 为 fn 的形参个数</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> fn.length </span><span style="color:#F92672;">&gt;</span><span style="color:#F8F8F2;"> args.length</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">?</span><span style="color:#F8F8F2;"> (</span><span style="color:#F92672;">...</span><span style="color:#FD971F;font-style:italic;">arguments</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">currying</span><span style="color:#F8F8F2;">(fn, </span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args, </span><span style="color:#F92672;">...</span><span style="color:#FD971F;">arguments</span><span style="color:#F8F8F2;">)</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">fn</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args);</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div><h2 id="jsonp" tabindex="-1"><a class="header-anchor" href="#jsonp" aria-hidden="true">#</a> JSONP</h2><div class="custom-container tip"><p class="custom-container-title">原理</p><p>利用<code>&lt;script&gt;</code> 标签没有跨域限制的性质，网页可以得到其他源产生的 JSON 数据，为什么不用<code>&lt;img&gt;</code> <code>&lt;link&gt;</code> 呢，因为只有 <code>script</code> 标签可以指定 <code>Content-Type : text/javaScript</code>，其他返回的只有数据，而不是脚本，并不会执行。</p></div><p>优点：</p><ul><li>兼容性好，操作简单。</li></ul><p>缺点：</p><ul><li>仅仅只支持 get 请求。</li><li>get 请求携带参数受限，大小 4kb 左右。</li><li>不够安全，可能会遭受 xss 攻击。</li></ul><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">jsonp</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> ({ </span><span style="color:#FD971F;font-style:italic;">url</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">params</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">callback</span><span style="color:#F8F8F2;"> }) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 生成链接</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">generateUrl</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> () </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> dataSrc </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;&#39;</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 拼接参数</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">for</span><span style="color:#F8F8F2;"> (</span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> key </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> params) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#66D9EF;font-style:italic;">Object</span><span style="color:#F8F8F2;">.hasOwnProperty.</span><span style="color:#A6E22E;">call</span><span style="color:#F8F8F2;">(params, key)) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        dataSrc </span><span style="color:#F92672;">+=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">`</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">key</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">params[key]</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">&amp;`</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">    }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    dataSrc </span><span style="color:#F92672;">+=</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">`callback=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">callback</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">`</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">`</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">url</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">?</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">dataSrc</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">`</span><span style="color:#F8F8F2;">;</span></span>\n<span class="line"><span style="color:#F8F8F2;">  };</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">reject</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 创建 script 标签</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> scriptEl </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> document.</span><span style="color:#A6E22E;">createElement</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;script&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    scriptEl.src </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">generateUrl</span><span style="color:#F8F8F2;">();</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 在全局对象上挂载回调函数</span></span>\n<span class="line"><span style="color:#F8F8F2;">    window[callback] </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">data</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 移除 script 标签</span></span>\n<span class="line"><span style="color:#F8F8F2;">      scriptEl.parentNode.</span><span style="color:#A6E22E;">removeChild</span><span style="color:#F8F8F2;">(scriptEl);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">delete</span><span style="color:#F8F8F2;"> window[callback];</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(data);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    };</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span></span>\n<span class="line"><span style="color:#F8F8F2;">    scriptEl.</span><span style="color:#A6E22E;">onerror</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;font-style:italic;">err</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">delete</span><span style="color:#F8F8F2;"> window[callback];</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 移除 script 标签</span></span>\n<span class="line"><span style="color:#F8F8F2;">      scriptEl.parentNode.</span><span style="color:#A6E22E;">removeChild</span><span style="color:#F8F8F2;">(scriptEl);</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(err);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    };</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 插入到页面，立即发起请求</span></span>\n<span class="line"><span style="color:#F8F8F2;">    document.body.</span><span style="color:#A6E22E;">appendChild</span><span style="color:#F8F8F2;">(scriptEl);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  });</span></span>\n<span class="line"><span style="color:#F8F8F2;">};</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#88846F;">// 测试</span></span>\n<span class="line"><span style="color:#A6E22E;">jsonp</span><span style="color:#F8F8F2;">({</span></span>\n<span class="line"><span style="color:#F8F8F2;">  url: </span><span style="color:#E6DB74;">&#39;https://s.weibo.com/ajax/jsonp/suggestion&#39;</span><span style="color:#F8F8F2;">,</span></span>\n<span class="line"><span style="color:#F8F8F2;">  params: { key: </span><span style="color:#E6DB74;">&#39;Oops&#39;</span><span style="color:#F8F8F2;">, _cb: </span><span style="color:#E6DB74;">&#39;jsonpCallback&#39;</span><span style="color:#F8F8F2;"> },</span></span>\n<span class="line"><span style="color:#F8F8F2;">  callback: </span><span style="color:#E6DB74;">&#39;jsonpCallback&#39;</span><span style="color:#F8F8F2;">,</span></span>\n<span class="line"><span style="color:#F8F8F2;">}).</span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">data</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(data);</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// script 返回数据为： try{window.jsonpCallback&amp;&amp;jsonpCallback({&quot;code&quot;:100000,&quot;msg&quot;:&quot;&quot;,&quot;data&quot;:[]});}catch(e){}</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 接收到数据：{code: 100000, msg: &quot;&quot;, data: Array(0)}</span></span>\n<span class="line"><span style="color:#F8F8F2;">});</span></span>\n<span class="line"></span></code></pre></div>',51),c={id:"async",tabindex:"-1"},r=l("a",{class:"header-anchor",href:"#async","aria-hidden":"true"},"#",-1),y=F(" async "),i={href:"https://juejin.cn/post/6844904102053281806",target:"_blank",rel:"noopener noreferrer"},E=o('<details><summary>展开查看</summary><div class="language-javascript ext-js"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">/**</span></span>\n<span class="line"><span style="color:#88846F;"> * 手写 async await</span></span>\n<span class="line"><span style="color:#88846F;"> * https://juejin.cn/post/6844904102053281806</span></span>\n<span class="line"><span style="color:#88846F;"> */</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">asyncToGenerator</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">generatorFunc</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 返回的是一个新的函数</span></span>\n<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> () {</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 先调用generator函数 生成迭代器</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 对应 var gen = testG()</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> gen </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> generatorFunc.</span><span style="color:#A6E22E;">apply</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;">arguments</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 返回一个promise 因为外部是用.then的方式 或者await的方式去使用这个函数的返回值的</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// var test = asyncToGenerator(testG)</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// test().then(res =&gt; console.log(res))</span></span>\n<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">resolve</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">reject</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// 内部定义一个step函数 用来一步一步的跨过yield的阻碍</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// key有next和throw两种取值，分别对应了gen的next和throw方法</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// arg参数则是用来把promise resolve出来的值交给下一个yield</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">step</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">key</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">arg</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> generatorResult;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#88846F;">// 这个方法需要包裹在try catch中</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#88846F;">// 如果报错了 就把promise给reject掉 外部通过.catch可以获取到错误</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#F92672;">try</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          generatorResult </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> gen[key](arg);</span></span>\n<span class="line"><span style="color:#F8F8F2;">        } </span><span style="color:#F92672;">catch</span><span style="color:#F8F8F2;"> (error) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">reject</span><span style="color:#F8F8F2;">(error);</span></span>\n<span class="line"><span style="color:#F8F8F2;">        }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#88846F;">// gen.next() 得到的结果是一个 { value, done } 的结构</span></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> { value, done } </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> generatorResult;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (done) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 如果已经完成了 就直接resolve这个promise</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 这个done是在最后一次调用next后才会为true</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 以本文的例子来说 此时的结果是 { done: true, value: &#39;success&#39; }</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 这个value也就是generator函数最后的返回值</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(value);</span></span>\n<span class="line"><span style="color:#F8F8F2;">        } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 除了最后结束的时候外，每次调用gen.next()</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 其实是返回 { value: Promise, done: false } 的结构，</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 这里要注意的是Promise.resolve可以接受一个promise为参数</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#88846F;">// 并且这个promise参数被resolve的时候，这个then才会被调用</span></span>\n<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">Promise</span><span style="color:#F8F8F2;">.</span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">(</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// 这个value对应的是yield后面的promise</span></span>\n<span class="line"><span style="color:#F8F8F2;">            value</span></span>\n<span class="line"><span style="color:#F8F8F2;">          ).</span><span style="color:#A6E22E;">then</span><span style="color:#F8F8F2;">(</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// value这个promise被resove的时候，就会执行next</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// 并且只要done不是true的时候 就会递归的往下解开promise</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// 对应gen.next().value.then(value =&gt; {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">//    gen.next(value).value.then(value2 =&gt; {</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">//       gen.next()</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">//</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">//      // 此时done为true了 整个promise被resolve了</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">//      // 最外部的test().then(res =&gt; console.log(res))的then就开始执行了</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">//    })</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// })</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">onResolve</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">val</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">              </span><span style="color:#A6E22E;">step</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;next&#39;</span><span style="color:#F8F8F2;">, val);</span></span>\n<span class="line"><span style="color:#F8F8F2;">            },</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// 如果promise被reject了 就再次进入step函数</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// 不同的是，这次的try catch中调用的是gen.throw(err)</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#88846F;">// 那么自然就被catch到 然后把promise给reject掉啦</span></span>\n<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">onReject</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">err</span><span style="color:#F8F8F2;">) {</span></span>\n<span class="line"><span style="color:#F8F8F2;">              </span><span style="color:#A6E22E;">step</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;throw&#39;</span><span style="color:#F8F8F2;">, err);</span></span>\n<span class="line"><span style="color:#F8F8F2;">            }</span></span>\n<span class="line"><span style="color:#F8F8F2;">          );</span></span>\n<span class="line"><span style="color:#F8F8F2;">        }</span></span>\n<span class="line"><span style="color:#F8F8F2;">      }</span></span>\n<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#A6E22E;">step</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;next&#39;</span><span style="color:#F8F8F2;">);</span></span>\n<span class="line"><span style="color:#F8F8F2;">    });</span></span>\n<span class="line"><span style="color:#F8F8F2;">  };</span></span>\n<span class="line"><span style="color:#F8F8F2;">}</span></span>\n<span class="line"></span></code></pre></div></details>',1);e.render=function(o,F){const e=s("OutboundLink");return n(),a(p,null,[t,l("h2",c,[r,y,l("a",i,[l(e)])]),E],64)};export default e;
